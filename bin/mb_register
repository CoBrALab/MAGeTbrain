#!/bin/bash
help="
Default registration script for MAGeT brain. 

Usage: 
    mb-register [options] <source> <target> <xfm>
                   
Options: 
    --affine          Perform affine registration only.
    --resample        Resample <source> image after registration.
    --mask MASK       Mask on <source> used during registration.
    -n --dry-run      Dry run.
    -v --verbose      Be verbose.

Registers <source> to <target> image and outputs the resulting xfm to <xfm>.
Intermediate and other files are output into the same directory as xfm.

If source image is /path/image/source.mnc, then /path/mask/source_mask.mnc is
checked for existence.  If so, it's used as a mask during non-linear
registration unless overridden with the use of --mask. 
"  

eval "$(docopts -h "$help" : "$@")"

source_stem=$(basename $source .mnc)
target_stem=$(basename $target .mnc)
source_mask=${mask:-$(dirname $(dirname $source))/masks/${source_stem}_mask.mnc}
output_dir=$(dirname $xfm)

lin_xfm=$output_dir/${source_stem}.${target_stem}-lin.xfm
lin_inv_xfm=$output_dir/$(basename $lin_xfm .xfm)_inverse.xfm
nl_xfm=$output_dir/${source_stem}.${target_stem}-nl.xfm
nl_inv_xfm=$output_dir/$(basename $nl_xfm .xfm)_inverse.xfm

source_linres=$output_dir/${source_stem}-linres.mnc
source_mask_linres=$output_dir/${source_stem}-mask-linres.mnc
source_nlres=$output_dir/${source_stem}-nlres.mnc
source_mask_nlres=$output_dir/${source_stem}-mask-nlres.mnc

function run { 
    [[ $verbose == "true" ]] && echo "$@"; [[ $dry_run == "false" ]] && eval $@;
}

function runr { 
    out=$1; shift; 
    [[ $verbose == "true" ]] && echo "$@ > $out"; 
    [[ $dry_run == "false" ]] && eval $@ > $out;
}

run mkdir -p $output_dir

if [[ ! -e $lin_xfm ]]; then 
    runr $output_dir/linreg.log \
    mincANTS 3 -m CC[$source,$target,1,4] \
        -i 0 \
        -o $lin_xfm \
        --number-of-affine-iterations 10000x10000x10000x10000x10000 \
        --affine-gradient-descent-option 0.5x0.95x1.e-4x1.e-4 \
        --MI-option 32x16000;
    run rm -f $lin_inv_xfm;
fi

if [[ ! -e $source_linres ]]; then 
    run mincresample \
        -sinc -like $target \
        -transform $lin_xfm $source $source_linres
fi

if [[ $affine == "false" ]]; then
    if [[ ! -e $source_mask ]]; then
        run mincresample -sinc -like $target \
            -transform $lin_xfm \
            $source_mask $source_mask_linres
        ANTS_MASK_ARGS="-x $source_mask_linres"
    fi 

    if [[ ! -e $nl_inv_xfm ]]; then 
        runr $output_dir/nlreg.log \
        mincANTS 3 -m CC[$target,$source_linres,1,4] \
            $ANTS_MASK_ARGS \
            --continue-affine false \
            --use-Histogram-Matching \
            -r Gauss[3,0] \
            -t SyN[0.5] \
            -o $nl_xfm \
            -i 100x100x100x20
        rm -f $nl_xfm ${nl_xfm/.xfm/_grid_0.mnc} 
    fi 

    [[ ! -e $xfm ]] && run xfmconcat $lin_xfm $nl_inv_xfm $xfm 

    [[ $resample == "true" ]] && run mincsample -sinc \
        -like $target -transform $xfm \
        $source $source_nlres

    run rm -f $nl_inv_xfm ${nl_inv_xfm/.xfm/_grid_0.mnc} \
          $lin_xfm $source_linres $source_mask_linres
fi 

