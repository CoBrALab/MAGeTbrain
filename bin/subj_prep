#!/bin/bash
set -euo pipefail
set -x

tmpdir=$(mktemp -d)

subject=$1
resmodel=$2
xfm=$3
modelsubject=$4
cropmodel=$5

movingfile=${subject}
fixedfile=${resmodel}
movingmask=NOMASK
fixedmask=$(dirname $(dirname ${resmodel}))/mask/mask.mnc
movingmask=NOMASK
movingmaskfine=$(dirname $(dirname ${resmodel}))/mask/mask.mnc

fixed_minimum_resolution=$(python -c "print(min([abs(x) for x in [float(x) for x in \"$(PrintHeader ${fixedfile} 1)\".split(\"x\")]]))")
fixed_maximum_resolution=$(python -c "print(max([ a*b for a,b in zip([abs(x) for x in [float(x) for x in \"$(PrintHeader ${fixedfile} 1)\".split(\"x\")]],[abs(x) for x in [float(x) for x in \"$(PrintHeader ${fixedfile} 2)\".split(\"x\")]])]))")

affinesteps=$(ants_generate_iterations.py --min ${fixed_minimum_resolution} --max ${fixed_maximum_resolution} --output multilevel-halving)

antsRegistration --dimensionality 3 --verbose --minc \
  --output [ ${tmpdir}/reg ] \
  --use-histogram-matching 1 \
  --initial-moving-transform [ ${fixedfile},${movingfile},1] \
  $(eval echo ${affinesteps})

xfminvert -clobber ${tmpdir}/reg0_GenericAffine.xfm ${xfm}

xfminvert -clobber ${xfm} $(dirname ${xfm})/$(basename ${xfm} .xfm)_inverse.xfm
mincresample -clobber -sinc -like ${cropmodel} -transform ${xfm} ${subject} ${tmpdir}/resample.mnc
mincmath -clobber -clamp -const2 0 $(mincstats -quiet -max ${subject}) ${tmpdir}/resample.mnc ${modelsubject}

rm -rf ${tmpdir}
