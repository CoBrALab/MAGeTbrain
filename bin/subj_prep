#!/bin/bash

set -e

subject=$1
#nucsubject=$1
resmodel=$2
xfm=$3
modelsubject=$4
cropmodel=$5

xfminvert=$(dirname $xfm)/$(basename $xfm .xfm)_inverse.xfm

#cropmodel=$(mktemp -d)/model.mnc
#nu_correct -quiet -iter 100 -stop 0.0001 -fwhm 0.1 {0} {1}'.format(subject.image, nuc_subject)
#nu_correct -quiet -iter 100 -stop 0.0001 -fwhm 0.1 $subject $nucsubject

#autocrop -from $resmodel -step $(mincinfo -attvalue xspace:step $subject) $(mincinfo -attvalue yspace:step $subject) $(mincinfo -attvalue zspace:step $subject) $resmodel $cropmodel


#bestlinreg -noverbose -lsq12 {0} {1} {2}'.format(nuc_subject, res_model, transform_file)
#bestlinreg.pl -noverbose -lsq12 $subject $resmodel $xfm
#xfminvert $xfm $xfminvert

#mincANTS 3 -m MI[$subject,$cropmodel,1,32] \
#    -i 0 \
#    -o $xfm \
#    --number-of-affine-iterations 10000x10000x10000x10000x10000 \
#    --continue-affine true \
#    --MI-option 32x32000 \
#    --use-Histogram-Matching

bestlinreg_g -clobber -noverbose -nmi -lsq12 $subject $cropmodel $xfm

xfminvert $xfm $xfminvert

#autocrop -from $resmodel -step $(mincinfo -attvalue xspace:step $subject) $(mincinfo -attvalue yspace:step $subject) $(mincinfo -attvalue zspace:step $subject) $resmodel $cropmodel

#mincresample -sinc -like {0} -2 -transform {1} {2} {3}'.format(res_model, transform_file, nuc_subject, modelsubject)
#mincresample -sinc -short -unsigned -like $cropmodel -2 -transform $xfm $subject $modelsubject
itk_resample --like $cropmodel --transform $xfm $subject $modelsubject

#if [ -e $modelsubject ]; then
#  rm output/nuc/templates/*imp
#  rm output/nuc/subjects/*imp
#fi

#command = 'nu_correct -quiet -iter 100 -stop 0.0001 -fwhm 0.1 $subject $nucsubject'
#echo $command

#command = 'bestlinreg -noverbose -lsq12 $nucsubject $resmodel $xfm'
#echo $command

#command = 'mincresample -sinc -like $resmodel -2 -transform $xfm $nucsubject $modelsubject'
#echo $command
