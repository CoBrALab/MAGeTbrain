#!/bin/bash
set -euo pipefail
set -x

export ITK_GLOBAL_DEFAULT_NUMBER_OF_THREADS=${THREADS_PER_COMMAND:-$(nproc)}

tmpdir=$(mktemp -d)

subject=$1
resmodel=$2
xfm=$3
modelsubject=$4
cropmodel=$5

movingmask=NOMASK
fixedfile=${cropmodel}
movingfile=${subject}
movingmaskfine=NOMASK

if [[ -s $(dirname $(dirname ${resmodel}))/mask/mask.mnc ]]; then
  antsApplyTransforms -d 3 -i $(dirname $(dirname ${resmodel}))/mask/mask.mnc -o ${tmpdir}/mask.mnc -n GenericLabel -r ${fixedfile} --verbose
  fixedmask=${tmpdir}/mask.mnc
else
  fixedmask=NOMASK
fi

fixedmaskfine=${fixedmask}

fixed_minimum_resolution=$(python -c "print(min([abs(x) for x in [float(x) for x in \"$(PrintHeader ${fixedfile} 1)\".split(\"x\")]]))")
fixed_maximum_resolution=$(python -c "print(max([ a*b for a,b in zip([abs(x) for x in [float(x) for x in \"$(PrintHeader ${fixedfile} 1)\".split(\"x\")]],[abs(x) for x in [float(x) for x in \"$(PrintHeader ${fixedfile} 2)\".split(\"x\")]])]))")

affinesteps=$(mb_ants_generate_iterations.py --min ${fixed_minimum_resolution} --max ${fixed_maximum_resolution} --output multilevel-halving --convergence 1e-7)

antsRegistration --dimensionality 3 --verbose --minc \
  --output [ ${tmpdir}/reg ] \
  --use-histogram-matching 0 \
  --initial-moving-transform [ ${fixedfile},${movingfile},1 ] \
  $(eval echo ${affinesteps})

cp -f ${tmpdir}/reg0_GenericAffine.xfm $(dirname ${xfm})/$(basename ${xfm} .xfm)_inverse.xfm
xfminvert -clobber ${tmpdir}/reg0_GenericAffine.xfm ${xfm}

antsApplyTransforms -d 3 -i ${subject} \
  -r ${cropmodel} \
  -t ${tmpdir}/reg0_GenericAffine.xfm -n BSpline[5] -o ${tmpdir}/resample.mnc

mincmath -clobber -clamp -const2 0 $(mincstats -quiet -max ${tmpdir}/resample.mnc) ${tmpdir}/resample.mnc ${modelsubject}

rm -rf ${tmpdir}
